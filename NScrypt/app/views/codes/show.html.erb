<%- model_class = Code -%>
<div class="page-header">
  <h1><%= @code.sign_state == 'Signed' ? 'Contract' : 'Draft' %></h1>
</div>

<p>
  <strong>Contract:</strong>
  <%= link_to @code.contract.title, contract_path(@code.contract) %>
</p>
<p>
  <strong>Version:</strong>
  <%= @code.version %>
</p>
<p>
  <strong>Overall Status:</strong>
  <%= @code.state %>
</p>
<p>
  <strong>Signature:</strong>
  <%= @code.sign_state %>
</p>
<p>
  <strong>Assignments:</strong>
  <%= @code.assign_state %>
</p>
<p>
  <strong>Proposed:</strong>
  <%= @code.proposed == "t" ? "Yes" : "No" %>
</p>
<p>
  <strong>Posted:</strong>
  <%= @code.posted == "t" ? "Yes" : "No" %>
</p>
<p>
  <strong>Rejected:</strong>
  <%= @code.rejected ? "Yes" : "No" %>
</p>

<textarea readonly rows="50" cols="80"><%= @code.code %></textarea>

<% if @code.proposed == "t" %>
  <p>NOTE: As this draft has been submitted, it cannot be edited. Create a duplicate to make alterations, which you can later submit as a separate proposal.</p>
<% end %>

<p>
  <% if @code.proposed != "t" && @code.sign_state == 'Unsigned' %>
    <%= link_to "Edit Code", edit_code_path(@code), :class => 'btn btn-default' %>
  <% else %>
    <%= link_to "Duplicate", action: "duplicate", code_id: @code.id %>
  <% end %>

  <% if @code.proposed != "t" && @code.assign_state == 'Assigned' %>
    <%= link_to "Propose", action: "propose", code_id: @code.id %>
  <% elsif @code.posted != "t" && @code.sign_state == 'Pre-signed' && @code.assign_state == 'Self-assigned' %>
    <%= link_to "Post", action: "post", code_id: @code.id %>
  <% end %>

  <% if @code.proposed == "t" && @code.author != session[:user_id] && !@code.rejected %>
    <%= link_to "Reject", action: "reject", code_id: @code.id %>
  <% end %>
</p>

<h2>Signatures</h2>
<table class="table table-striped">
  <thead>
    <tr>
      <th>Role</th>
      <th>Party Name</th>
      <th>Signed</th>
      <th>Signature Date</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody>
    <% @code.parties.each do |party| %>
      <tr>
        <td><%= party.role %></td>
        <td>
          <% if party.user.nil? %>
            <%= form_for party, url: {controller: "parties", action: "assign", party_id: party.id} do |f| %>
              <%= f.select(:user, options_from_collection_for_select(User.all, :id, :name)) %>
              <%= f.submit "Assign" %>
            <% end %>
          <% else %>
            <%= party.user.name %>
          <% end %>
        </td>
        <td><%= party.state == 'Signed' ? 'Yes' : 'No' %></td>
        <td><%= party.state == 'Signed' ?  party.updated_at : 'N/A' %></td>
        <td>
          <% if !party.user.nil? %>
            <% if party.user.id == session[:user_id] %>
              <% if party.state != 'Signed' %>
                <%= link_to "Sign", controller: "parties", action: "sign", party_id: party.id %>
              <% else %>
                <%= link_to "Unsign", controller: "parties", action: "unsign", party_id: party.id unless @code.sign_state == 'Signed' %>
              <% end %>
            <% end %>
          <% end %>
        </td>
      </tr>
    <% end %>
  </tbody>
</table>
